# Libcararian

## 概要

Libcararianは、PDFファイルを管理し、結合や丁付け（小冊子印刷用のページ並べ替え）を行うためのWebアプリケーションです。アップロードされた複数のPDFファイルを、一括で結合したり、曲ごとに指定したページ範囲で個別のPDFファイルとして出力したりすることができます。丁付けやページ番号の追加といったオプションも提供しています。

## 主な機能

* **PDFファイルのアップロード**: ドラッグ＆ドロップまたはファイル選択ダイアログでPDFファイルをアップロードできます。
* **ファイル一覧の並べ替え**: アップロードしたファイルの一覧をドラッグ＆ドロップで並べ替えることができます。
* **PDFプレビュー**: ファイル一覧から選択したPDFの内容をプレビュー表示できます。
* **一括結合**: アップロードした全てのPDFを一つのファイルに結合します。その際、以下のオプションを選択できます。
    * **小冊子**: 印刷時に小冊子になるようにページを並べ替えます。
    * **ページ番号**: PDFにページ番号を付与します。開始番号や、番号を付けない表紙のページ数も指定可能です。
* **曲ごとの結合**: 指定したページ範囲ごとにPDFを分割・抽出し、個別のファイルとしてZIP形式でダウンロードできます。

## クライアント・サーバー間の通信

### ファイルのアップロード

* **クライアントからの送信**:
    * **手段**: HTMLのフォーム送信（`POST`）または、GAE（Google App Engine）環境ではJavaScriptの`fetch` APIによるPUTリクエスト。
    * **情報**:
        1.  まず、ファイル名とファイルタイプをJSON形式で `/generate_signed_url` へPOSTします。
        2.  次に、サーバーから受け取った署名付きURLに対して、PDFファイル本体を`PUT`メソッドで送信します。
        3.  ローカル環境では、`/upload` へ multipart/form-data 形式でPDFファイルをPOSTします。
* **サーバーからの返信**:
    * **手段**: HTTPリダイレクト。
    * **情報**: GAE環境の場合、`/generate_signed_url` が署名付きURLを文字列として返します。ファイルのアップロード処理後、サーバーはファイル情報をセッションに保存し、クライアントをトップページ (`/`) にリダイレクトさせます。

### ファイルリストの並べ替え

* **クライアントからの送信**:
    * **手段**: JavaScriptの`fetch` API (`POST`)。
    * **エンドポイント**: `/update_file_order`。
    * **情報**: 並べ替えられた後のファイル名の順序をJSON形式の配列で送信します (例: `{"order": ["file2.pdf", "file1.pdf", ...]}`)。
* **サーバーからの返信**:
    * **手段**: JSONレスポンス。
    * **情報**: 処理の成功を示すステータスを返します (例: `{"status": "success"}`)。

### ファイルのプレビュー

* **クライアントからの送信**:
    * **手段**: JavaScriptの`fetch` API (`GET`)。
    * **エンドポイント**: `/preview/<filename>` (`<filename>`はプレビューしたいファイル名)。
    * **情報**: エンドポイントのURLパスに含まれるファイル名。
* **サーバーからの返信**:
    * **手段**: `send_file`によるファイル送信。
    * **情報**: 指定されたPDFファイル本体。ブラウザはこれをインラインで表示します。

### 一括結合

* **クライアントからの送信**:
    * **手段**: HTMLのフォーム送信 (`GET`)。
    * **エンドポイント**: `/combine`。
    * **情報**: フォームで選択されたオプションがURLクエリパラメータとして送信されます (例: `?isBooklet=booklet&isNumbering=numbering&start-number=1&no-number-pages=2`)。
* **サーバーからの返信**:
    * **手段**: `send_file`によるファイル送信。
    * **情報**: 結合・処理されたPDFファイル本体。ダウンロード用の添付ファイルとして送信されます。

### 曲ごとの結合

* **クライアントからの送信**:
    * **手段**: JavaScriptの`fetch` API (`POST`)。
    * **エンドポイント**: `/combine_by_song`。
    * **情報**: ダイアログで入力された、接頭辞、開始ページ番号、そして各曲の曲番号、曲名、開始・終了ページ番号のリストがJSON形式で送信されます。
* **サーバーからの返信**:
    * **手段**: HTTPリダイレクトと、その後の`send_file`によるファイル送信。
    * **情報**:
        1.  `/combine_by_song` ルートは、処理後にZIPファイルのダウンロード用エンドポイント `/zip_download` へリダイレクトさせます。
        2.  クライアントがリダイレクト先の `/zip_download` にアクセスすると、サーバーは生成されたZIPファイルを添付ファイルとして送信します。

### ファイルの削除/クリア

* **クライアントからの送信**:
    * **手段**: `<a>`タグによる画面遷移 (`GET`)。
    * **エンドポイント**: `/delete` または `/clear`。
    * **情報**: なし。
* **サーバーからの返信**:
    * **手段**: HTTPリダイレクト。
    * **情報**: サーバーはセッション内のファイル情報を削除し、実ファイルもストレージから削除した後、クライアントをトップページ (`/`) にリダイレクトさせます。